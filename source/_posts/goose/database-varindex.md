title: goose自己写的搜索引擎-动态索引
date: 2014-09-17 21:20:25
categories: 
- 技术
- 搜索引擎
tags:
- goose
- golang
- 搜索引擎
---

VarIndex提供动态索引功能,支持在检索阶段动态插入新的索引并能够在短时间内被检索得到.

<!-- more -->

##一、设计思想
* 静态索引为主,动态索引为辅
* 支持动态增加索引 
* 不支持索引删除.(整个goose的原则上就不支持索引删除)
* 动态索引量很小.如果有大批量的更新,那应该考虑是否改重新建库了.
* 无论如何都需要保证高速读取是可以正常提供服务.

##二、实现构成

动态索引在实现上由两个[磁盘索引DiskIndex](/技术/搜索引擎/goose/database-diskindex/)和一个[内存索引MemoryIndex](/技术/搜索引擎/goose/database-memoryindex/)组成.

MemoryIndex的特性是支持读写,但是不可持久化存储的.
DiskIndex的特性是要不只读,要不只写,但是是可持久化存储的.

一个磁盘库叫做`读取库`,它只能进行读取操作.
另外一个磁盘库叫做`合并库`,它只能进行写入操作.

来个图:
![动态索引结构图](/static/img/goose-varindex-arch.png)

##三、索引读取
如架构图所示,索引读取的时候同时读取内存库以及只读库,然后进行归并.

```go
func (*VarIndex) ReadIndex(t TermSign)(*InvList,error)
```
动态库提供的接口保持简洁,如无需要其它模块仍然不需要关注细节.

##四、写入索引
再如上图,将所需要写入的索引直接往内存库写入即是.

内存库是支持同时读写的,直接写进去之后马上就能被检索出来.


##五、索引同步
动态库如上所说已经支持动态读取写入索引了,但是还存在着一下的问题:

* 内存索引随着更新,越来越大怎么办?
* 程序突然崩溃,内存索引全丢了怎么办?

使用动态库的模块,需要定时调用动态库的合并操作接口
```go
func (*VarIndex) Sync() (error)
```

内部会进行一系列同步操作,先来个图:
![动态索引合并](/static/img/goose-varindex-sync.png)

###停止写操作
待会要把内存库整个写到磁盘,这个时候不得不停止内存库再进行写入了.

###索引库归并
开始进行索引库归并,合并只读库以及内存库,然后写入合并库

###索引读取正常
在索引库合并的过程中,依然保持索引读取正常提供服务

###切换
完成合并后,所有索引数据都已经合并到合并库了.
这个时候快速做两个事情:

* 切换`合并库`以及`读取库`
* 清空内存库

完成以后,整个动态索引就变成了下图:
![动态索引合并完成](/static/img/goose-varindex-swap.png)

这个时候,状态回到了最初的样子,继续提供动态索引功能.



##六、还有问题
以上设计,已经基本可以大概也许够用了.
但是在某下比较苛刻的情况下,还是会出问题.

__Q__:如果索引已经写到内存库,但是还是来不及sync同步到磁盘,程序崩溃重启了怎么办?
__A__:保安,麻烦把这个人拖出去,谢谢!

这个问题只能这样解决了:

1. 用户自己解决
如果崩溃了,那么短期内的索引请重发

2. 增加回放功能
所有收到的增量更新,先备份到磁盘,等到确认的确写入到了内存索引且同步到了磁盘索引再删除备份数据.
程序重启的时候都先检查是否有丢失数据,如果有必须进行数据重灌.
为了goose稍微简单,没有实现这个逻辑,这个地方略有不足.


